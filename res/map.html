<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
	</style>
        <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ojST3jwr9LGTWTIwxak4z6hkE11N6yMx"></script>
	<title>地图展示</title>
</head>
<body>
	<div id="allmap"></div>
</body>
</html>
<script type="text/javascript">
	// 百度地图API功能
    var mapShowLevel = 16;
	var map = new BMap.Map("allmap");    // 创建Map实例
	map.centerAndZoom(new BMap.Point(114.435035,30.463954), 16);  // 初始化地图,设置中心点坐标和地图级别
	map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
     
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});
    map.addControl(top_left_control);
      
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放    

// 经纬度接口
function showTheLocaltion(allpointinfo,type)
{
    //alert(allpointinfo);
    var pointArray = allpointinfo.split('|');
    for(var i=0;i<pointArray.length;i++)
    {
        pointvalue = pointArray[i].split(',');
        if(pointvalue.length != 2)
        {
             //格式出错
             return 1;
        }
         var p = new BMap.Point(pointvalue[0],pointvalue[1]); //点位置
         var marker1 = new BMap.Marker(p);  // 创建标注
         if(type == 1)
         {
            var myIcon = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25), {
                                 offset: new BMap.Size(10, 25), // 指定定位位置
                                 imageOffset: new BMap.Size(0, 0 - 10 * 25) // 设置图片偏移
                             });
            marker1.setIcon(myIcon);
         }
         else
         {
            marker1.addEventListener("click", doClickMarker);
         }    
           
        map.addOverlay(marker1);              // 将标注添加到地图中
        var label = new BMap.Label(i+1,{offset:new BMap.Size(20,-10)});
        marker1.setLabel(label);
        marker1.setTitle(pointvalue[0] + "," +pointvalue[1]);
        if(i == 0)
        {
              map.centerAndZoom(new BMap.Point(pointvalue[0],pointvalue[1]), mapShowLevel );  
        }
    }
    
    if(type == 1)
    {
        drawWalkArea(allpointinfo,type);
    }   
    //map.panTo(marker1);    
}

//移动到指定经纬度
function moveTheLocaltion(JD , WD)
{
    var marker1 = new BMap.Marker(new BMap.Point(JD,WD));  // 创建标注
    //map.panTo(marker1);
    map.centerAndZoom(new BMap.Point(JD,WD), mapShowLevel );  
    
}

//区域划线
//type=1画蓝线，真实位置，type=0画红线
function drawWalkArea(allpointinfo, type)
{
      //assert(pointArray.length);
      //assert(pointArray.length);
      //alert(allpointinfo);
    var points = [];
    var pointArray = allpointinfo.split('|');
    for(var i=0;i<pointArray.length;i++)
    {
      pointvalue = pointArray[i].split(',');
      if(pointvalue.length != 2)
      {
         //格式出错
         return 1;
      }
      p1 = new BMap.Point(pointvalue[0],pointvalue[1]);
      points.push(p1);
    }
// CurveLine

    var color;
    if(type == 1)
    {
        color = "blue";
    }
    else if(type == 0)
    {
        color = "red";
    }
    var polyline = new BMap.Polyline(points , {strokeColor:color, strokeWeight:3, strokeOpacity:0.5}); 

    map.addOverlay(polyline ); //添加到地图中
	
}

function clear()
{
    map.clearOverlays();
}

//百度坐标转GPS坐标 格式为 x,y|x,y|x,y
//type:0 转gps坐标 1转百度坐标
function toFixPoint(pointSet , type)
{
    
    var resultstr="";
    var tmppoint;
    var projection = new BMap.MercatorProjection();
   
    
   
    var pointArray = pointSet.split('|');
    
    for(var i=0;i<pointArray.length;i++)
    {
        //取出x和y的值
        
        pointvalue = pointArray[i].split(',');
       
        if(pointvalue.length != 2)
        {
           //格式出错
           return "error";
        }
      if(type == 0)
      {
          tmppoint= projection.lngLatToPoint(new BMap.Point(pointvalue[0],pointvalue[1]));
          resultstr += tmppoint.x + "," + tmppoint.y;
      }
      else
      {
         tmppoint= projection.pointToLngLat(new BMap.Pixel(pointvalue[0],pointvalue[1]));
         resultstr += tmppoint.lng + "," + tmppoint.lat;
      }
      
      if(i != pointArray.length -1)
      {
         resultstr += "|";
      }
        
    }
    return resultstr;
}

var tileLayer = new BMap.TileLayer({isTransparentPng: true});

//初始化网格
tileLayer.getTilesUrl = function(tileCoord, zoom) {
    var x = tileCoord.x;
    var y = tileCoord.y;
    return "http://developer.baidu.com/map/jsdemo/img/border.png";
}

//新增网格
function add_grid(){
    map.addTileLayer(tileLayer);
}

//删除网格
function delete_grid(){
    map.removeTileLayer(tileLayer);
}

//显示所有基站位置
function showAllBaseLocation(allpointinfo)
{
    var pointArray = allpointinfo.split('|');
    var points = [];  // 添加所有基站点位置
    for(var i = 0; i < pointArray.length; i++)
    {
        pointvalue = pointArray[i].split(',');
        if(pointvalue.length != 2)
        {
             //格式出错
             return 1;
        }
        points.push(new BMap.Point(pointvalue[0],pointvalue[1]));
    }
    
    var options = {
        size: BMAP_POINT_SIZE_BIG,
        shape: BMAP_POINT_SHAPE_RHOMBUS,
        color: '#d340c3'
    };
    
    var pointCollection = new BMap.PointCollection(points, options);  // 初始化PointCollection
    map.addOverlay(pointCollection);  // 添加Overlay
}

var overlays = [];
// 在地图上显示参与计算的基站位置,格式：lng,lat,radius,lac,ci,rxlev|...
function addBaseLocation(allpointinfo)
{
    while(overlays.length !== 0) {
        map.removeOverlay(overlays.pop());
    }
    
    var tmpArray = allpointinfo.split('|');
    var usedPoints = [];
    var unusedPoints = [];
    for(var i = 0; i < tmpArray.length; i++)
    {
        pointvalue = tmpArray[i].split(',');
        if(pointvalue.length != 6)
        {
             //格式出错
             return 1;
        }
        var p = new BMap.Point(pointvalue[0],pointvalue[1]); //点位置
        p.index = i;
        p.radius = pointvalue[2];
        p.lac = pointvalue[3];
        p.ci = pointvalue[4];
        p.rxlev = pointvalue[5];
               
        if(i < 6) {
            usedPoints.push(p);
            //画圆
            var circle = new BMap.Circle(p, pointvalue[2], {strokeColor:"green", strokeWeight:2, strokeOpacity:0.5});
            circle.setFillOpacity(0.01);
            map.addOverlay(circle);
            //保存marker1和circle,以便下一次画图是清除
            overlays.push(circle);
        } else {
            unusedPoints.push(p);
        }
    }
    
    var usedPointOptions = {
        size: BMAP_POINT_SIZE_BIG,
        shape: BMAP_POINT_SHAPE_CIRCLE,
        color: 'green'
    };
    
    var unusedPointOptions = {
        size: BMAP_POINT_SIZE_BIG,
        shape: BMAP_POINT_SHAPE_CIRCLE,
        color: 'yellow'
    };

    
    var usedPointCollection = new BMap.PointCollection(usedPoints, usedPointOptions);  // 初始化PointCollection
    usedPointCollection.addEventListener('click', doClickBase);
    var unusedPointCollection = new BMap.PointCollection(unusedPoints, unusedPointOptions);  // 初始化PointCollection
    unusedPointCollection.addEventListener('click', doClickBase);
    overlays.push(usedPointCollection);
    overlays.push(unusedPointCollection);
    map.addOverlay(usedPointCollection);  // 添加Overlay
    map.addOverlay(unusedPointCollection);
}

// 处理marker的单击事件
function doClickMarker(click) {
    //console.info(click.point); //获得被点击位置的经纬度
    //console.info(click.target.getLabel().content); //获得被点击的marker的label的内容
    
    var content = click.target.getLabel().content.toString(); //content保存了测量点序号
    location.href = content; //将content通过一个url发送给Qt
    
    //addBaseLocation("114.434859,30.4641974,200|114.434868,30.4650268,200|114.430991,30.4644528,200|114.430988,30.4639009,200|");
}

function doClickBase(click) {
    //console.info(click.point.index); //测试给Point对象加的index
    
    //格式：lng,lat,radius,lac,ci,rxlev
    var p = click.point;
    
    var opts = {
        width : 250,     // 信息窗口宽度
        height: 100,     // 信息窗口高度
        title : "LAC: " + p.lac + "; CI: " + p.ci, // 信息窗口标题
	}
	var infoWindow = new BMap.InfoWindow("位置：" + p.lng + "," + p.lat + "；<br>半径：" + p.radius + "；场强：" + p.rxlev, opts);  // 创建信息窗口对象
    map.openInfoWindow(infoWindow, click.point); //开启信息窗口
}

add_grid();

//showTheLocaltion(116.404,39.915);
//showTheLocaltion(114.435035,30.463954);
//var arrpoints = [];
//var p1 =  new BMap.Point(114.435035,30.463954);
//var p2 =  new BMap.Point(114.433304,30.460344);
//arrpoints.push(114.435035);
//arrpoints.push(30.463954);
//arrpoints.push(114.433304);
//arrpoints.push(30.460344);
//drawWalkArea(arrpoints);
//teststr = "114.426,34.527|117.554,36.446|119.852,30.554";
//showTheLocaltion(teststr);
//toFixPoint(teststr  , 1);
//showTheLocaltion("114.426,34.527|117.554,36.446|119.852,30.554",0);
//showTheLocaltion("114.434859,30.4641974|114.434868,30.4650268|114.430991,30.4644528|114.430988,30.4639009|",0);
//addBaseLocation("114.434859,30.4641974,200,7138,1234,-89|114.434868,30.4650268,300,7138,3456,-90|114.430991,30.4644528,400,7138,5678,-70");
</script>
